<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TOEIC 800 Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #222;
      background: #f5f5f7;
    }
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #f5f5f7 0%, #e3ecff 60%, #f5f5f7 100%);
    }
    .app {
      max-width: 1100px;
      margin: 24px auto;
      padding: 16px;
    }
    h1 {
      margin-top: 0;
      font-size: 1.6rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    h1 span.badge {
      background: #2563eb;
      color: #fff;
      font-size: 0.8rem;
      padding: 2px 8px;
      border-radius: 999px;
    }
    .subbadge {
      font-size: 0.78rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f97316;
      color: #fff;
      margin-left: 4px;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(260px, 1fr);
      gap: 16px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: rgba(255, 255, 255, 0.94);
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .card-header h2 {
      font-size: 1rem;
      margin: 0;
    }
    .card-header small {
      opacity: 0.7;
      font-size: 0.78rem;
    }
    label {
      font-size: 0.9rem;
      display: block;
      margin-bottom: 6px;
    }
    input[type="number"],
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #cbd5f5;
      font-size: 0.9rem;
      box-sizing: border-box;
      background: #f9fafb;
    }
    select[multiple] {
      height: 84px;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.1s ease;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #fff;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.38);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }
    .btn-secondary {
      background: #e5e7eb;
    }
    .btn-ghost {
      background: transparent;
      border: 1px solid #e5e7eb;
    }
    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.18);
    }
    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
      justify-content: space-between;
    }
    .controls-right {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }
    .questions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 8px;
      max-height: 70vh;
      overflow: auto;
      padding-right: 4px;
    }
    .question-card {
      border-radius: 12px;
      padding: 10px 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }
    .question-header {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: #6b7280;
    }
    .question-text {
      font-size: 0.92rem;
      margin-bottom: 6px;
    }
    .choices {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.88rem;
    }
    .choices label {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      margin: 0;
      padding: 2px 4px;
      border-radius: 8px;
      cursor: pointer;
    }
    .choices input[type="radio"] {
      margin-top: 2px;
    }
    .explanation {
      margin-top: 4px;
      font-size: 0.8rem;
      display: none;
      padding: 6px 8px;
      border-radius: 6px;
      background: #eef2ff;
    }
    .explanation.correct {
      border-left: 2px solid #16a34a;
    }
    .explanation.incorrect {
      border-left: 2px solid #dc2626;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 1px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #e0f2fe;
      color: #0369a1;
    }
    .summary-line {
      font-size: 0.86rem;
      margin: 3px 0;
    }
    .summary-line strong {
      font-weight: 600;
    }
    .summary-highlight {
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 8px;
      background: #fef3c7;
      font-size: 0.82rem;
    }
    .mini {
      font-size: 0.76rem;
      opacity: 0.8;
    }
    .history-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      margin-top: 4px;
    }
    .history-table th,
    .history-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    .history-table th {
      font-weight: 600;
      background: #f1f5f9;
    }
    .history-table tr:hover {
      background: #f9fafb;
    }
    .pill {
      font-size: 0.72rem;
      padding: 1px 6px;
      border-radius: 999px;
      background: #e5e7eb;
    }
    .score-good {
      color: #15803d;
      font-weight: 600;
    }
    .score-mid {
      color: #ca8a04;
      font-weight: 600;
    }
    .score-bad {
      color: #b91c1c;
      font-weight: 600;
    }
    .timer {
      font-size: 0.8rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #1d4ed8;
    }
    .mode-select {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }
    .mode-select select {
      max-width: 240px;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>
      TOEIC 800 Trainer
      <span>
        <span class="badge">Local Â· Offline</span>
        <span class="subbadge">Target: 800+</span>
      </span>
    </h1>

    <div class="layout">
      <!-- å·¦ï¼šå‡ºé¢˜ & ä½œç­”åŒº -->
      <div class="card">
        <div class="card-header">
          <h2>å‡ºé¢˜ Â· åšé¢˜</h2>
          <small>çœŸé¢˜é£æ ¼ Â· è¯­æ³• / è¯æ±‡ / é˜…è¯»é€Ÿåº¦è®­ç»ƒ</small>
        </div>

        <div>
          <div class="mode-select">
            <label for="modeSelect" style="margin-bottom:0;">è®­ç»ƒæ¨¡å¼ï¼š</label>
            <select id="modeSelect">
              <option value="mixed">ç»¼åˆè®­ç»ƒï¼ˆæ¨èï¼‰</option>
              <option value="grammar">è¯­æ³• Â· Part 5 å¼ºåŒ–</option>
              <option value="reading">é˜…è¯» Â· Part 7 å¼ºåŒ–</option>
              <option value="listening">å¬åŠ›é£æ ¼ Â· è¯­æ„Ÿå¼ºåŒ–</option>
            </select>
          </div>

          <label>
            æœ¬æ¬¡é¢˜ç›®æ•°é‡ï¼ˆ1â€“20 æ¨èï¼‰
            <input id="numQuestions" type="number" min="1" max="50" value="10" />
          </label>

          <label>
            è‡ªå®šä¹‰ TOEIC éƒ¨åˆ†ï¼ˆå¯é€‰ï¼Œé»˜è®¤æ ¹æ®è®­ç»ƒæ¨¡å¼è‡ªåŠ¨é€‰æ‹©ï¼‰
            <select id="partsSelect" multiple>
              <option value="Part5">Part 5 - Incomplete Sentences</option>
              <option value="Part6">Part 6 - Text Completion</option>
              <option value="Part7">Part 7 - Reading Comprehension</option>
              <option value="Listening">Listening-style (Vocabulary / Grammar)</option>
            </select>
          </label>

          <div class="controls-row">
            <div class="mini">
              è®¡æ—¶ï¼š<span id="timerDisplay">00:00</span> Â·
              å½“å‰å¹³å‡æ¯é¢˜ç”¨æ—¶ï¼š<span id="avgTimeDisplay">-- ç§’</span>
            </div>
            <div class="controls-right">
              <button class="btn btn-ghost" id="btnShowAllExp" type="button">
                æ˜¾ç¤º/éšè—å…¨éƒ¨è§£æ
              </button>
              <button class="btn btn-secondary" id="btnResetCurrent" type="button">
                æ¸…ç©ºå½“å‰ä½œç­”
              </button>
              <button class="btn btn-primary" id="btnStart" type="button">
                ğŸ¯ æŠ½é¢˜å¼€å§‹
              </button>
            </div>
          </div>
        </div>

        <div id="questionsContainer" class="questions"></div>

        <div class="controls-row" style="margin-top: 10px; justify-content:flex-end;">
          <button class="btn btn-primary" id="btnSubmit" type="button">
            âœ… æäº¤å¹¶åˆ†æ
          </button>
        </div>
      </div>

      <!-- å³ï¼šåˆ†æ & è®°å½•åŒº -->
      <div class="card">
        <div class="card-header">
          <h2>åˆ†æ Â· è®°å½•</h2>
          <small>æŒ‰è¯­æ³• / è¯æ±‡ / é˜…è¯»é€Ÿåº¦å®šä½è–„å¼±ç‚¹</small>
        </div>

        <div id="summaryBox">
          <p class="summary-line">
            è¿˜æ²¡æœ‰ç»“æœã€‚å…ˆåœ¨å·¦ä¾§ <strong>é€‰æ‹©è®­ç»ƒæ¨¡å¼</strong>ï¼Œç‚¹å‡»
            <strong>â€œæŠ½é¢˜å¼€å§‹â€</strong>ï¼Œåšå®Œé¢˜åå†ç‚¹å‡»
            <strong>â€œæäº¤å¹¶åˆ†æâ€</strong>ã€‚
          </p>
          <p class="mini">
            æç¤ºï¼šç›®æ ‡ 800+ æ—¶ï¼Œæ•´ä½“æ­£ç¡®ç‡å»ºè®® â‰¥ 80%ï¼Œå¹³å‡æ¯é¢˜ç”¨æ—¶ â‰¤ 45 ç§’ã€‚
          </p>
        </div>

        <hr style="margin: 10px 0; border: none; border-top: 1px dashed #e5e7eb;" />

        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 4px;">
          <strong style="font-size: 0.9rem;">å†å²è®°å½•ï¼ˆæœ¬æœºä¿å­˜ï¼‰</strong>
          <button class="btn btn-ghost" id="btnClearHistory" type="button" style="font-size: 0.78rem; padding: 4px 10px;">
            ğŸ§¹ æ¸…ç©ºå†å²
          </button>
        </div>
        <div id="historyBox"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== ç¤ºä¾‹çœŸé¢˜é£æ ¼é¢˜åº“ï¼ˆå¯åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­æ‰‹åŠ¨æ‰©å±•ï¼‰ =====
    // è¿™é‡Œåªæ”¾å°‘é‡ç¤ºä¾‹ï¼Œç”¨äºç»“æ„è¯´æ˜ä¸è®­ç»ƒé€»è¾‘ã€‚
    const QUESTION_BANK = [
      {
        id: 1,
        part: "Part5",
        skill: "Grammar: Tense / Passive",
        focus: "grammar",
        question: "The report ______ by the time the manager arrives tomorrow.",
        choices: ["will finish", "will have been finished", "was finished", "has finished"],
        correctIndex: 1,
        explanation:
          "\"by the time + å°†æ¥æ—¶é—´\" å¸¸ç”¨å°†æ¥å®Œæˆæ—¶ï¼›è¿™é‡Œ report æ˜¯è¢«åŠ¨ï¼Œæ‰€ä»¥ç”¨ future perfect passiveï¼šwill have been finished."
      },
      {
        id: 2,
        part: "Part5",
        skill: "Vocabulary: Preposition",
        focus: "vocabulary",
        question: "The new policy will go ______ effect next Monday.",
        choices: ["in", "on", "into", "for"],
        correctIndex: 2,
        explanation: "å›ºå®šæ­é…ï¼šgo into effect è¡¨ç¤ºâ€œå¼€å§‹ç”Ÿæ•ˆâ€ã€‚"
      },
      {
        id: 3,
        part: "Part5",
        skill: "Grammar: Conjunction",
        focus: "grammar",
        question:
          "Employees must submit their travel receipts ______ they can be reimbursed.",
        choices: ["so that", "because of", "despite", "instead of"],
        correctIndex: 0,
        explanation: "so that + å¥å­ è¡¨ç¤ºâ€œä»¥ä¾¿â€¦â€¦â€ã€‚åé¢æ˜¯å®Œæ•´å¥å­ they can be reimbursedã€‚"
      },
      {
        id: 4,
        part: "Part6",
        skill: "Reading: Coherence",
        focus: "reading",
        question:
          "All staff are reminded to keep the reception area clean. ______, please avoid leaving personal items on the front desk.",
        choices: ["However", "For example", "In addition", "Therefore"],
        correctIndex: 2,
        explanation:
          "å‰æ–‡æ˜¯æé†’ä¿æŒå¹²å‡€ï¼Œåé¢æ˜¯è¡¥å……å…·ä½“è¦æ±‚ï¼Œâ€œæ­¤å¤–â€æœ€è‡ªç„¶ï¼šIn addition."
      },
      {
        id: 5,
        part: "Part7",
        skill: "Reading: Detail Question",
        focus: "reading",
        question:
          "According to the email, why is the meeting rescheduled to Friday?",
        choices: [
          "The conference room is not available.",
          "The manager will be out of town on Thursday.",
          "The report is not finished yet.",
          "The clients requested a different time."
        ],
        correctIndex: 1,
        explanation:
          "æ ¹æ®è®¾å®šï¼šå› ä¸ºç»ç†å‘¨å››ä¸åœ¨å…¬å¸ï¼Œæ‰€ä»¥æ”¹åˆ°å‘¨äº”ã€‚çœŸå®ä½¿ç”¨æ—¶ä½ å¯ä»¥æ ¹æ®è‡ªå·±é˜…è¯»ææ–™æ”¹å†™é¢˜å¹²ã€‚"
      },
      {
        id: 6,
        part: "Listening",
        skill: "Listening-style: Short Conversation",
        focus: "listening",
        question:
          "What does the woman mean when she says, â€œI wish you had told me earlierâ€?",
        choices: [
          "She is happy she knew it in advance.",
          "She is upset because she did not know it earlier.",
          "She wants the man to repeat the information.",
          "She already knew about it."
        ],
        correctIndex: 1,
        explanation:
          "è™šæ‹Ÿè¯­æ°” I wish you had told me earlier é€šå¸¸è¡¨ç¤ºâ€œæ—©çŸ¥é“å°±å¥½äº†â€ï¼Œæš—å«ä¸æ»¡æˆ–é—æ†¾ã€‚"
      },
      {
        id: 7,
        part: "Part5",
        skill: "Vocabulary: Collocation",
        focus: "vocabulary",
        question:
          "The company offers a wide ______ of training programs for new employees.",
        choices: ["number", "range", "amount", "piece"],
        correctIndex: 1,
        explanation: "å›ºå®šæ­é…ï¼ša wide range of + å¯æ•°åè¯å¤æ•°ã€‚"
      },
      {
        id: 8,
        part: "Part6",
        skill: "Grammar: Article / Reference",
        focus: "grammar",
        question:
          "Please sign ______ agreement and return it to the human resources office by Friday.",
        choices: ["a", "an", "the", "no article"],
        correctIndex: 2,
        explanation:
          "è¯´çš„æ˜¯åŒæ–¹éƒ½çŸ¥é“çš„â€œé‚£ä»½åè®®â€ï¼Œç”¨ theã€‚å¥ä¸­åˆå‡ºç° it å›æŒ‡ agreementã€‚"
      },
      {
        id: 9,
        part: "Part7",
        skill: "Reading: Inference",
        focus: "reading",
        question:
          "What can be inferred about the workshop from the notice?",
        choices: [
          "It is only for new employees.",
          "It will be held after business hours.",
          "Participants must register in advance.",
          "It is free for the general public."
        ],
        correctIndex: 2,
        explanation:
          "æ ¹æ®è®¾å®šï¼šå…¬å‘Šä¸­æåˆ° â€œSpace is limited. Please register online by July 10.â€ â†’ å¯æ¨æ–­éœ€è¦äº‹å…ˆæŠ¥åã€‚"
      },
      {
        id: 10,
        part: "Listening",
        skill: "Listening-style: Intonation / Attitude",
        focus: "listening",
        question:
          "How does the man probably feel when he says, â€œWell, thatâ€™s one way to look at itâ€?",
        choices: [
          "He completely agrees.",
          "He politely disagrees.",
          "He is confused.",
          "He is excited."
        ],
        correctIndex: 1,
        explanation:
          "è¡¨è¾¾æ–¹å¼ Well, thatâ€™s one way to look at it. å¸¸ç”¨æ¥å§”å©‰è¡¨è¾¾ä¸åŒæ„è§ï¼Œå±äºç¤¼è²Œæ€§ä¸åŒæ„ã€‚"
      }
    ];

    // ===== å·¥å…·å‡½æ•° =====
    function shuffle(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function formatDateTime(dt) {
      return (
        dt.getFullYear() +
        "-" +
        String(dt.getMonth() + 1).padStart(2, "0") +
        "-" +
        String(dt.getDate()).padStart(2, "0") +
        " " +
        String(dt.getHours()).padStart(2, "0") +
        ":" +
        String(dt.getMinutes()).padStart(2, "0")
      );
    }

    function accuracyClass(acc) {
      if (acc >= 0.85) return "score-good";
      if (acc >= 0.6) return "score-mid";
      return "score-bad";
    }

    function formatDuration(seconds) {
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60);
      return String(m).padStart(2, "0") + ":" + String(s).padStart(2, "0");
    }

    // ===== å…¨å±€çŠ¶æ€ =====
    let currentQuestions = [];
    let quizStartTime = null;
    let timerInterval = null;

    // ===== DOM å…ƒç´  =====
    const numQuestionsInput = document.getElementById("numQuestions");
    const partsSelect = document.getElementById("partsSelect");
    const modeSelect = document.getElementById("modeSelect");
    const questionsContainer = document.getElementById("questionsContainer");
    const btnStart = document.getElementById("btnStart");
    const btnSubmit = document.getElementById("btnSubmit");
    const btnResetCurrent = document.getElementById("btnResetCurrent");
    const btnShowAllExp = document.getElementById("btnShowAllExp");
    const summaryBox = document.getElementById("summaryBox");
    const historyBox = document.getElementById("historyBox");
    const btnClearHistory = document.getElementById("btnClearHistory");
    const timerDisplay = document.getElementById("timerDisplay");
    const avgTimeDisplay = document.getElementById("avgTimeDisplay");

    // ===== å†å²è®°å½•å­˜å–ï¼ˆlocalStorageï¼‰ =====
    const HISTORY_KEY = "toeic_800_trainer_history";

    function loadHistory() {
      try {
        const raw = localStorage.getItem(HISTORY_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.error("Failed to parse history", e);
        return [];
      }
    }

    function saveHistory(history) {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }

    function renderHistory() {
      const history = loadHistory();
      if (!history.length) {
        historyBox.innerHTML =
          '<p style="font-size:0.8rem;opacity:0.7;">è¿˜æ²¡æœ‰è®°å½•ã€‚æ¯æ¬¡â€œæäº¤å¹¶åˆ†æâ€ä¼šè‡ªåŠ¨ä¿å­˜æˆç»©ã€‚</p>';
        return;
      }
      let html = '<table class="history-table">';
      html +=
        "<thead><tr><th>æ—¶é—´</th><th>æ¨¡å¼</th><th>åˆ†æ•°</th><th>å‡†ç¡®ç‡</th><th>é¢˜é‡</th><th>æ€»ç”¨æ—¶</th><th>å¼±é¡¹æ‘˜è¦</th></tr></thead><tbody>";
      for (const item of history.slice().reverse()) {
        const acc = item.correct / item.total;
        const accPct = (acc * 100).toFixed(0) + "%";
        const accClass = accuracyClass(acc);
        html += "<tr>";
        html += `<td>${item.timestamp}</td>`;
        html += `<td>${item.mode || "-"}</td>`;
        html += `<td><span class="${accClass}">${item.correct}/${item.total}</span></td>`;
        html += `<td>${accPct}</td>`;
        html += `<td>${item.total}</td>`;
        html += `<td>${item.durationStr || "-"}</td>`;
        html += `<td>${item.weakSummary || "-"}</td>`;
        html += "</tr>";
      }
      html += "</tbody></table>";
      historyBox.innerHTML = html;
    }

    // ===== æ¸²æŸ“é¢˜ç›® =====
    function renderQuestions(questions) {
      questionsContainer.innerHTML = "";
      if (!questions.length) {
        questionsContainer.innerHTML =
          '<p style="font-size:0.9rem;opacity:0.8;">å½“å‰æ¡ä»¶ä¸‹æ²¡æœ‰å¯ç”¨é¢˜ç›®ï¼Œè¯·è¯•ç€æ”¾å®½é€‰æ‹©æˆ–åœ¨å¼€å‘è€…å·¥å…·ä¸­æ‰©å……é¢˜åº“ã€‚</p>';
        return;
      }
      questions.forEach((q, index) => {
        const card = document.createElement("div");
        card.className = "question-card";
        card.dataset.questionId = q.id;

        const header = document.createElement("div");
        header.className = "question-header";
        header.innerHTML = `
          <span>#${index + 1} Â· ${q.part}</span>
          <span class="tag">${q.skill}</span>
        `;
        card.appendChild(header);

        const text = document.createElement("div");
        text.className = "question-text";
        text.textContent = q.question;
        card.appendChild(text);

        const choices = document.createElement("div");
        choices.className = "choices";
        q.choices.forEach((choice, ci) => {
          const id = `q${q.id}_c${ci}`;
          const label = document.createElement("label");
          label.innerHTML = `
            <input type="radio" name="q_${q.id}" value="${ci}" id="${id}" />
            <span>(${String.fromCharCode(65 + ci)}) ${choice}</span>
          `;
          choices.appendChild(label);
        });
        card.appendChild(choices);

        const exp = document.createElement("div");
        exp.className = "explanation";
        exp.textContent = "è§£æï¼š" + q.explanation;
        card.appendChild(exp);

        questionsContainer.appendChild(card);
      });
    }

    // ===== è®­ç»ƒæ¨¡å¼ â†’ é»˜è®¤ Part æ˜ å°„ =====
    function getPartsForMode(mode) {
      switch (mode) {
        case "grammar":
          return ["Part5"];
        case "reading":
          return ["Part6", "Part7"];
        case "listening":
          return ["Listening"];
        case "mixed":
        default:
          return ["Part5", "Part6", "Part7", "Listening"];
      }
    }

    function getFocusForMode(mode) {
      switch (mode) {
        case "grammar":
          return "Grammar";
        case "reading":
          return "Reading";
        case "listening":
          return "Listening-style";
        case "mixed":
        default:
          return "Mixed";
      }
    }

    // ===== è®¡æ—¶ =====
    function resetTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      timerDisplay.textContent = "00:00";
      avgTimeDisplay.textContent = "-- ç§’";
      quizStartTime = null;
    }

    function startTimer() {
      resetTimer();
      quizStartTime = new Date();
      timerInterval = setInterval(() => {
        if (!quizStartTime) return;
        const now = new Date();
        const seconds = Math.floor((now - quizStartTime) / 1000);
        timerDisplay.textContent = formatDuration(seconds);
      }, 1000);
    }

    // ===== å¼€å§‹å‡ºé¢˜ =====
    function startQuiz() {
      const num = Math.max(
        1,
        Math.min(50, parseInt(numQuestionsInput.value, 10) || 1)
      );

      const selectedMode = modeSelect.value;

      // å¦‚æœç”¨æˆ·æ²¡æœ‰ç‰¹æ„å¤šé€‰ partï¼Œå°±ä½¿ç”¨æ¨¡å¼é»˜è®¤æ˜ å°„
      const selectedPartsRaw = Array.from(partsSelect.selectedOptions).map(
        (o) => o.value
      );
      const effectiveParts =
        selectedPartsRaw.length > 0
          ? selectedPartsRaw
          : getPartsForMode(selectedMode);

      const available = QUESTION_BANK.filter((q) =>
        effectiveParts.includes(q.part)
      );
      const shuffled = shuffle(available);
      currentQuestions = shuffled.slice(0, num);

      renderQuestions(currentQuestions);
      startTimer();

      summaryBox.innerHTML =
        '<p class="summary-line">å·²æŠ½å– <strong>' +
        currentQuestions.length +
        "</strong> é¢˜ï¼ˆæ¨¡å¼ï¼š" +
        getFocusForMode(selectedMode) +
        "ï¼‰ã€‚è®¡æ—¶å·²å¼€å§‹ï¼Œåšå®Œé¢˜åç‚¹å‡» <strong>â€œæäº¤å¹¶åˆ†æâ€</strong>ã€‚</p>" +
        '<p class="mini">ç›®æ ‡ 800+ å»ºè®®ï¼šæ•´ä½“æ­£ç¡®ç‡ â‰¥ 80%ï¼Œå¹³å‡æ¯é¢˜ç”¨æ—¶ â‰¤ 45 ç§’ã€‚</p>';
    }

    // ===== æäº¤å¹¶åˆ†æ =====
    function submitAndAnalyze() {
      if (!currentQuestions.length) {
        alert("è¯·å…ˆç‚¹å‡»â€œæŠ½é¢˜å¼€å§‹â€ç”Ÿæˆé¢˜ç›®ã€‚");
        return;
      }

      let correctCount = 0;
      let answeredCount = 0;

      const statsByPart = {};
      const statsBySkill = {};
      const statsByFocus = { grammar: { correct: 0, total: 0 },
                             vocabulary: { correct: 0, total: 0 },
                             reading: { correct: 0, total: 0 },
                             listening: { correct: 0, total: 0 } };

      currentQuestions.forEach((q) => {
        const selected = document.querySelector(
          'input[name="q_' + q.id + '"]:checked'
        );
        const card = document.querySelector(
          '.question-card[data-question-id="' + q.id + '"]'
        );
        const exp = card.querySelector(".explanation");

        let isCorrect = false;
        if (selected) {
          answeredCount++;
          const chosenIndex = parseInt(selected.value, 10);
          if (chosenIndex === q.correctIndex) {
            correctCount++;
            isCorrect = true;
          }
        }

        // éƒ¨åˆ†ç»Ÿè®¡
        if (!statsByPart[q.part]) statsByPart[q.part] = { correct: 0, total: 0 };
        statsByPart[q.part].total++;
        if (isCorrect) statsByPart[q.part].correct++;

        // æŠ€èƒ½ç»Ÿè®¡
        if (!statsBySkill[q.skill])
          statsBySkill[q.skill] = { correct: 0, total: 0 };
        statsBySkill[q.skill].total++;
        if (isCorrect) statsBySkill[q.skill].correct++;

        // ç„¦ç‚¹ç»Ÿè®¡ï¼ˆgrammar / vocabulary / reading / listeningï¼‰
        if (q.focus && statsByFocus[q.focus]) {
          statsByFocus[q.focus].total++;
          if (isCorrect) statsByFocus[q.focus].correct++;
        }

        // å±•ç¤ºè§£æ
        exp.style.display = "block";
        exp.classList.remove("correct", "incorrect");
        exp.classList.add(isCorrect ? "correct" : "incorrect");
      });

      if (answeredCount === 0) {
        alert("ä½ è¿˜æ²¡æœ‰ä½œç­”ä»»ä½•é¢˜ç›®ï¼Œè¯·å…ˆé€‰æ‹©ç­”æ¡ˆã€‚");
        return;
      }

      // åœæ­¢è®¡æ—¶
      let durationSeconds = 0;
      if (quizStartTime) {
        const now = new Date();
        durationSeconds = Math.max(
          1,
          Math.floor((now - quizStartTime) / 1000)
        );
      }
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
      const avgTimePerQuestion = durationSeconds / answeredCount;
      avgTimeDisplay.textContent = avgTimePerQuestion.toFixed(1) + " ç§’";

      const total = currentQuestions.length;
      const accuracy = correctCount / total;
      const accuracyPct = (accuracy * 100).toFixed(1) + "%";

      const selectedMode = modeSelect.value;
      const modeLabel = getFocusForMode(selectedMode);

      let html = "";
      html += `<p class="summary-line">æœ¬æ¬¡æ¨¡å¼ï¼š<strong>${modeLabel}</strong></p>`;
      html += `<p class="summary-line">æœ¬æ¬¡å¾—åˆ†ï¼š<strong class="${accuracyClass(
        accuracy
      )}">${correctCount} / ${total}</strong> ï¼ˆå‡†ç¡®ç‡ ${accuracyPct}ï¼‰</p>`;
      html += `<p class="summary-line">å·²ä½œç­”é¢˜ç›®ï¼š${answeredCount} / ${total}</p>`;
      html += `<p class="summary-line">æ€»ç”¨æ—¶ï¼š<strong>${formatDuration(
        durationSeconds
      )}</strong> Â· å¹³å‡æ¯é¢˜ï¼š<strong>${avgTimePerQuestion.toFixed(
        1
      )} ç§’</strong></p>`;

      // Part ç»Ÿè®¡
      html += `<p class="summary-line"><strong>æŒ‰ TOEIC éƒ¨åˆ†ç»Ÿè®¡ï¼š</strong></p>`;
      html += "<ul style='padding-left:18px;font-size:0.82rem;'>";
      Object.entries(statsByPart).forEach(([part, stat]) => {
        const acc = stat.correct / stat.total;
        const pct = (acc * 100).toFixed(0) + "%";
        html += `<li>${part}: <span class="${accuracyClass(
          acc
        )}">${stat.correct}/${stat.total}</span> (${pct})</li>`;
      });
      html += "</ul>";

      // æŠ€èƒ½ç»Ÿè®¡
      html += `<p class="summary-line"><strong>æŒ‰æŠ€èƒ½æ ‡ç­¾ç»Ÿè®¡ï¼š</strong></p>`;
      const skillEntries = Object.entries(statsBySkill).sort(
        (a, b) => a[1].correct / a[1].total - b[1].correct / b[1].total
      );
      html += "<ul style='padding-left:18px;font-size:0.82rem;'>";
      skillEntries.forEach(([skill, stat]) => {
        const acc = stat.correct / stat.total;
        const pct = (acc * 100).toFixed(0) + "%";
        html += `<li>${skill}: <span class="${accuracyClass(
          acc
        )}">${stat.correct}/${stat.total}</span> (${pct})</li>`;
      });
      html += "</ul>";

      // ç„¦ç‚¹æ€»ç»“ï¼šè¯­æ³• / è¯æ±‡ / é˜…è¯» / å¬åŠ›
      html += `<p class="summary-line"><strong>æŒ‰è®­ç»ƒç„¦ç‚¹ç»Ÿè®¡ï¼š</strong></p>`;
      html += "<ul style='padding-left:18px;font-size:0.82rem;'>";
      ["grammar", "vocabulary", "reading", "listening"].forEach((f) => {
        const stat = statsByFocus[f];
        if (!stat || stat.total === 0) return;
        const acc = stat.correct / stat.total;
        const pct = (acc * 100).toFixed(0) + "%";
        const label =
          f === "grammar"
            ? "è¯­æ³•"
            : f === "vocabulary"
            ? "è¯æ±‡"
            : f === "reading"
            ? "é˜…è¯»"
            : "å¬åŠ›é£æ ¼";
        html += `<li>${label}: <span class="${accuracyClass(
          acc
        )}">${stat.correct}/${stat.total}</span> (${pct})</li>`;
      });
      html += "</ul>";

      // è–„å¼±ç‚¹å»ºè®®ï¼ˆæ ¹æ®ç„¦ç‚¹ & æ—¶é—´ï¼‰
      const weakFocusEntries = Object.entries(statsByFocus)
        .filter(([, s]) => s.total > 0)
        .sort((a, b) => a[1].correct / a[1].total - b[1].correct / b[1].total);

      let weakSummary = "";
      if (weakFocusEntries.length) {
        const top = weakFocusEntries[0];
        const key = top[0];
        const stat = top[1];
        const acc = stat.correct / stat.total;
        const label =
          key === "grammar"
            ? "è¯­æ³•"
            : key === "vocabulary"
            ? "è¯æ±‡"
            : key === "reading"
            ? "é˜…è¯»"
            : "å¬åŠ›é£æ ¼";
        weakSummary = `${label} ${stat.correct}/${stat.total}`;
        let advice = "";
        if (key === "grammar") {
          advice =
            "å»ºè®®è¿™å‡ å¤©é›†ä¸­åš Part 5 è¯­æ³•é¢˜ï¼ˆè¿è¯ã€æ—¶æ€ã€åˆ†è¯ã€ä»‹è¯ï¼‰ï¼ŒæŠŠé”™é¢˜æ•´ç†æˆè¯­æ³•ç¬”è®°ã€‚";
        } else if (key === "vocabulary") {
          advice =
            "å»ºè®®æ¯å¤©æ•´ç† 10â€“15 ä¸ªé«˜é¢‘å•†åŠ¡è¯æ±‡ï¼Œè¿åŒä¾‹å¥ä¸€èµ·è®°å¿†ï¼Œå¹¶åå¤åœ¨é¢˜ç›®ä¸­è§åˆ°å®ƒä»¬ã€‚";
        } else if (key === "reading") {
          advice =
            "å»ºè®®ç»ƒä¹  3â€“5 ç¯‡çŸ­æ–‡è®¡æ—¶é˜…è¯»ï¼Œç›®æ ‡æ˜¯æ¯é¢˜å¹³å‡ç”¨æ—¶æ§åˆ¶åœ¨ 45 ç§’ä»¥å†…ï¼ŒåŒæ—¶ä¸“æ³¨ç»†èŠ‚é¢˜ä¸æ¨ç†é¢˜ã€‚";
        } else if (key === "listening") {
          advice =
            "å»ºè®®æ¯å¤©å¬ 5â€“10 åˆ†é’ŸçœŸå®è¯­é€Ÿææ–™ï¼ˆå¦‚ TOEIC å¬åŠ› / å•†åŠ¡æ’­å®¢ï¼‰ï¼Œè·Ÿè¯»å…³é”®å¥ï¼Œæå‡è¯­æ„Ÿã€‚";
        }

        let speedAdvice = "";
        if (avgTimePerQuestion > 50) {
          speedAdvice =
            "ç›®å‰å¹³å‡æ¯é¢˜ç”¨æ—¶åé•¿ï¼Œå¯ä»¥å°è¯•å…ˆå¿«é€Ÿæµè§ˆé¢˜å¹²å’Œé€‰é¡¹ï¼Œå†å›åˆ°æ–‡ç« ä¸­å®šä½å…³é”®ä¿¡æ¯ï¼Œé€æ­¥å‹ç¼©ç”¨æ—¶ã€‚";
        } else if (avgTimePerQuestion > 40) {
          speedAdvice =
            "å¹³å‡æ¯é¢˜ç”¨æ—¶æ¥è¿‘ç›®æ ‡ï¼Œå†å¤šç»ƒå‡ ç»„é¢˜ï¼Œåˆ»æ„åœ¨ä¿è¯å‡†ç¡®ç‡å‰æä¸‹ç¨å¾®åŠ å¿«é˜…è¯»é€Ÿåº¦ã€‚";
        } else {
          speedAdvice =
            "å¹³å‡æ¯é¢˜ç”¨æ—¶å·²ç»ä¸é”™ï¼Œæ¥ä¸‹æ¥å¯ä»¥è¿½æ±‚åœ¨å¤æ‚é¢˜å‹ä¸Šä¿æŒè¿™ä¸ªèŠ‚å¥ã€‚";
        }

        html += `<div class="summary-highlight">
          è¿™æ¬¡è®­ç»ƒä¸­ç›¸å¯¹è¾ƒå¼±çš„æ–¹å‘æ˜¯ï¼š<strong>${weakSummary}</strong>ã€‚${advice}<br/>
          ${speedAdvice}
        </div>`;
      } else {
        html += `<div class="summary-highlight">
          æœ¬æ¬¡å„æ–¹å‘è¡¨ç°å‡è¡¡ã€‚å»ºè®®ç»§ç»­å¢åŠ é¢˜é‡ï¼Œè§‚å¯Ÿ 1â€“2 å‘¨çš„å†å²è®°å½•è¶‹åŠ¿ï¼Œå†é’ˆå¯¹æœ€å¸¸è§çš„é”™å› é›†ä¸­çªç ´ã€‚
        </div>`;
      }

      summaryBox.innerHTML = html;

      // ä¿å­˜åˆ°å†å²è®°å½•
      const history = loadHistory();
      history.push({
        timestamp: formatDateTime(new Date()),
        mode: modeLabel,
        correct: correctCount,
        total,
        duration: durationSeconds,
        durationStr: formatDuration(durationSeconds),
        weakSummary
      });
      saveHistory(history);
      renderHistory();
    }

    // ===== äº‹ä»¶ç»‘å®š =====
    btnStart.addEventListener("click", startQuiz);
    btnSubmit.addEventListener("click", submitAndAnalyze);

    btnResetCurrent.addEventListener("click", () => {
      if (!currentQuestions.length) return;
      currentQuestions.forEach((q) => {
        const radios = document.querySelectorAll(
          'input[name="q_' + q.id + '"]'
        );
        radios.forEach((r) => (r.checked = false));
        const card = document.querySelector(
          '.question-card[data-question-id="' + q.id + '"]'
        );
        if (card) {
          const exp = card.querySelector(".explanation");
          if (exp) exp.style.display = "none";
        }
      });
      resetTimer();
      summaryBox.innerHTML =
        '<p class="summary-line">å½“å‰ä½œç­”å·²æ¸…ç©ºï¼Œå¯ä»¥é‡æ–°ä½œç­”æœ¬ç»„é¢˜ç›®æˆ–é‡æ–°æŠ½é¢˜ã€‚</p>' +
        '<p class="mini">æç¤ºï¼šå¦‚æœæƒ³ä¸“æ”»è¯­æ³•ï¼Œå¯ä»¥é€‰æ‹©â€œè¯­æ³• Â· Part 5 å¼ºåŒ–â€æ¨¡å¼ã€‚</p>';
    });

    btnShowAllExp.addEventListener("click", () => {
      const exps = document.querySelectorAll(".explanation");
      if (!exps.length) return;
      const anyHidden = Array.from(exps).some(
        (e) => e.style.display === "none" || !e.style.display
      );
      exps.forEach((e) => {
        e.style.display = anyHidden ? "block" : "none";
      });
    });

    btnClearHistory.addEventListener("click", () => {
      if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚")) return;
      saveHistory([]);
      renderHistory();
    });

    // é¡µé¢åˆå§‹åŒ–ï¼šè®¾ç½®é»˜è®¤æ¨¡å¼å¯¹åº”çš„ Partï¼Œå¹¶åŠ è½½å†å²
    window.addEventListener("DOMContentLoaded", () => {
      // æ ¹æ®é»˜è®¤æ¨¡å¼è®¾ç½®é€‰ä¸­çš„ Part
      const defaultParts = getPartsForMode(modeSelect.value);
      Array.from(partsSelect.options).forEach((opt) => {
        opt.selected = defaultParts.includes(opt.value);
      });

      // å½“æ¨¡å¼å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢ Part é€‰æ‹©ï¼ˆç”¨æˆ·ä¹Ÿå¯ä»¥æ‰‹åŠ¨å†æ”¹ï¼‰
      modeSelect.addEventListener("change", () => {
        const parts = getPartsForMode(modeSelect.value);
        Array.from(partsSelect.options).forEach((opt) => {
          opt.selected = parts.includes(opt.value);
        });
      });

      renderHistory();
    });
  </script>
</body>
</html>
