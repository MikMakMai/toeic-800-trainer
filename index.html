<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>TOEIC Trainer v3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #111827;
      background: #f3f4f6;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f3f4f6;
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 1.4rem;
      margin: 0 0 8px;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.06);
      padding: 12px 14px;
      margin-bottom: 12px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .controls label {
      font-size: 13px;
      color: #4b5563;
    }
    input[type="number"] {
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      width: 90px;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
    }
    .primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #fff;
    }
    .secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .section {
      margin-bottom: 12px;
    }
    .section h2 {
      font-size: 1rem;
      margin: 0 0 6px;
    }
    pre.passage {
      white-space: pre-wrap;
      background: #f9fafb;
      padding: 8px;
      border-radius: 8px;
      margin: 4px 0 8px;
      font-size: 13px;
      line-height: 1.4;
    }
    .question-block {
      margin-bottom: 8px;
    }
    .question-text {
      font-size: 14px;
      margin-bottom: 4px;
    }
    .choice {
      font-size: 14px;
      margin: 2px 0;
    }
    .choice input {
      margin-right: 6px;
    }
    .analysis-line {
      font-size: 13px;
      margin-top: 4px;
      border-top: 1px dashed #e5e7eb;
      padding-top: 4px;
    }
    .analysis-correct { color: #15803d; }
    .analysis-wrong { color: #b91c1c; }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #e5edff;
      color: #1d4ed8;
      margin-right: 4px;
    }
    .stats-row {
      font-size: 13px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px 12px;
      margin-top: 4px;
    }
    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: #f3f4f6;
      font-size: 11px;
      margin-right: 4px;
    }
    @media (max-width: 640px) {
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      button, input[type="number"] {
        width: 100%;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card">
    <h1>TOEIC Trainer v3ï¼ˆå¤šæ–‡ä»¶é¢˜åº“ç‰ˆï¼‰</h1>
    <div style="font-size:13px;color:#6b7280;margin-bottom:4px;">
      ğŸ¯ ç›®æ ‡ï¼šæ¯å¤© 10â€“100 é¢˜ï¼ŒæŒ‰ Part5 â†’ Part6 â†’ Part7 é¡ºåºç»ƒä¹ ï¼Œé˜…è¯»ä¸€ç¯‡æ–‡ç« å†…çš„å¤šé¢˜ä¸€èµ·å‡ºç°ã€‚å¬åŠ›éƒ¨åˆ†å·²å»é™¤ã€‚
    </div>
    <div class="controls">
      <label>æœ¬æ¬¡é¢˜é‡ï¼ˆ10â€“100ï¼‰ï¼š
        <input id="countInput" type="number" min="10" max="100" value="20" />
      </label>
      <button id="startBtn" class="primary">ğŸ¯ ç”Ÿæˆé¢˜ç›®</button>
      <button id="submitBtn" class="secondary">âœ… æäº¤å¹¶æŸ¥çœ‹è§£æ</button>
    </div>
    <div style="font-size:13px;color:#4b5563;">
      è®¡æ—¶ï¼š<span id="timer">00:00</span> Â· å¹³å‡æ¯é¢˜ï¼š<span id="avgTime">--</span> ç§’
    </div>
  </div>

  <div id="questionsContainer"></div>

  <div id="resultCard" class="card" style="display:none;">
    <h2 style="font-size:1rem;margin:0 0 6px;">æœ¬æ¬¡ç»“æœ</h2>
    <div id="summaryText" style="font-size:13px;margin-bottom:4px;"></div>
    <div id="detailStats" class="stats-row"></div>
    <div id="advice" style="font-size:13px;margin-top:6px;color:#0f172a;white-space:pre-wrap;"></div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h2 style="font-size:1rem;margin:0;">å†å²è®°å½•ï¼ˆä¿å­˜åœ¨æœ¬æœºï¼‰</h2>
      <button id="toggleHistory" class="secondary">æ˜¾ç¤º/éšè—</button>
    </div>
    <div id="historyBox" style="display:none;margin-top:6px;font-size:13px;"></div>
  </div>
</div>

<!-- å…ˆåŠ è½½é¢˜åº“ï¼Œå†åŠ è½½é€»è¾‘ -->
<script src="toeic-part5.js"></script>
<script src="toeic-part6.js"></script>
<script src="toeic-part7.js"></script>
<script>
/**
 * æœŸæœ›é¢˜åº“ç»“æ„ï¼š
 * - PART5_QUESTIONS: æ•°ç»„ï¼Œå…ƒç´  { id, part:5, question, options:{A,B,C,D}, answer, explanation }
 * - PART6_SETS: æ•°ç»„ï¼Œå…ƒç´  { id, part:6, title, passage, questions:[ { id, question, options, answer, explanation } ] }
 * - PART7_SETS: æ•°ç»„ï¼Œå…ƒç´ åŒä¸Šï¼Œpart:7
 */

function shuffle(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

let sessionItems = [];   // [{kind:"single"/"set", part, data}]
let ANSWER_KEY = {};     // qid -> { answer, part }
let startTime = null;
let timerId = null;

function startTimer() {
  if (timerId) clearInterval(timerId);
  startTime = Date.now();
  const timerEl = document.getElementById("timer");
  const avgEl = document.getElementById("avgTime");
  timerEl.textContent = "00:00";
  avgEl.textContent = "--";
  timerId = setInterval(() => {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const m = String(Math.floor(elapsed / 60)).padStart(2, "0");
    const s = String(elapsed % 60).padStart(2, "0");
    timerEl.textContent = m + ":" + s;
    const totalQ = Object.keys(ANSWER_KEY).length || 1;
    avgEl.textContent = (elapsed / totalQ).toFixed(1);
  }, 1000);
}

/** æ„å»ºæœ¬æ¬¡è®­ç»ƒé¢˜ç›®ï¼ŒæŒ‰ Part5 â†’ Part6 â†’ Part7 é¡ºåºï¼Œä¸æ‹†é˜…è¯»/æ®µè½ */
function buildSession(totalRequested) {
  const total = Math.max(10, Math.min(100, totalRequested || 20));
  let remaining = total;
  const items = [];
  ANSWER_KEY = {};

  // Part 5ï¼šå•é¢˜
  const p5 = shuffle((typeof PART5_QUESTIONS !== "undefined" ? PART5_QUESTIONS : []).slice());
  for (const q of p5) {
    if (remaining <= 0) break;
    items.push({ kind: "single", part: 5, data: q });
    ANSWER_KEY[q.id] = { answer: q.answer, part: 5 };
    remaining -= 1;
  }

  // Part 6ï¼šæ®µè½
  const p6 = shuffle((typeof PART6_SETS !== "undefined" ? PART6_SETS : []).slice());
  for (const set of p6) {
    const count = set.questions.length;
    if (remaining <= 0) break;
    // å·²ç»æœ‰é¢˜ç›®äº†ä¸”è¯¥æ®µè½é¢˜é‡è¶…è¿‡å‰©ä½™é¢˜é‡ï¼Œå°±å…ˆè·³è¿‡
    if (count > remaining && items.length > 0) continue;
    items.push({ kind: "set", part: 6, data: set });
    set.questions.forEach(q => {
      ANSWER_KEY[q.id] = { answer: q.answer, part: 6 };
    });
    remaining -= count;
  }

  // Part 7ï¼šé˜…è¯»
  const p7 = shuffle((typeof PART7_SETS !== "undefined" ? PART7_SETS : []).slice());
  for (const set of p7) {
    const count = set.questions.length;
    if (remaining <= 0) break;
    if (count > remaining && items.length > 0) continue;
    items.push({ kind: "set", part: 7, data: set });
    set.questions.forEach(q => {
      ANSWER_KEY[q.id] = { answer: q.answer, part: 7 };
    });
    remaining -= count;
  }

  sessionItems = items;
}

/** æ¸²æŸ“é¢˜ç›® */
function renderSession() {
  const container = document.getElementById("questionsContainer");
  container.innerHTML = "";
  document.getElementById("resultCard").style.display = "none";

  if (!sessionItems.length) {
    container.innerHTML = "<div class='card'>å½“å‰é¢˜åº“ä¸è¶³æˆ–æœªåŠ è½½æˆåŠŸï¼Œè¯·ç¨åå†è¯•ã€‚</div>";
    return;
  }

  sessionItems.forEach((item, idxSection) => {
    const sec = document.createElement("div");
    sec.className = "card section";
    const partLabel = `Part ${item.part}`;
    const title = item.data.title ? " Â· " + item.data.title : "";
    sec.innerHTML = `<h2><span class="badge">${partLabel}</span>ç¬¬ ${idxSection + 1} ç»„${title}</h2>`;

    if (item.kind === "single") {
      // Part 5 å•é¢˜
      const qBlock = document.createElement("div");
      qBlock.className = "question-block";
      qBlock.innerHTML = `<div class="question-text">${item.data.question}</div>`;
      const opts = item.data.options;
      for (const key of ["A","B","C","D"]) {
        if (!opts[key]) continue;
        const div = document.createElement("div");
        div.className = "choice";
        div.innerHTML = `
          <label>
            <input type="radio" name="q_${item.data.id}" value="${key}"> (${key}) ${opts[key]}
          </label>
        `;
        qBlock.appendChild(div);
      }
      const analysis = document.createElement("div");
      analysis.id = "analysis_" + item.data.id;
      analysis.className = "analysis-line";
      analysis.style.display = "none";
      qBlock.appendChild(analysis);
      sec.appendChild(qBlock);
    } else if (item.kind === "set") {
      // Part 6 / 7 æ®µè½+å¤šé¢˜
      const pre = document.createElement("pre");
      pre.className = "passage";
      pre.textContent = item.data.passage;
      sec.appendChild(pre);

      item.data.questions.forEach((q, idxQ) => {
        const qBlock = document.createElement("div");
        qBlock.className = "question-block";
        const numPrefix = item.part === 6 ? `(ç©ºæ ¼ ${idxQ + 1}) ` : `Q${idxQ + 1}. `;
        qBlock.innerHTML = `<div class="question-text">${numPrefix}${q.question}</div>`;
        for (const key of ["A","B","C","D"]) {
          if (!q.options[key]) continue;
          const div = document.createElement("div");
          div.className = "choice";
          div.innerHTML = `
            <label>
              <input type="radio" name="q_${q.id}" value="${key}"> (${key}) ${q.options[key]}
            </label>
          `;
          qBlock.appendChild(div);
        }
        const analysis = document.createElement("div");
        analysis.id = "analysis_" + q.id;
        analysis.className = "analysis-line";
        analysis.style.display = "none";
        qBlock.appendChild(analysis);
        sec.appendChild(qBlock);
      });
    }

    container.appendChild(sec);
  });
}

/** è¯„åˆ† */
function grade() {
  if (!sessionItems.length) return;
  if (timerId) clearInterval(timerId);

  const answers = ANSWER_KEY;
  let correct = 0;
  let total = 0;
  let wrongP5 = 0, wrongP6 = 0, wrongP7 = 0;

  for (const qid in answers) {
    total++;
    const meta = answers[qid];
    const chosenEl = document.querySelector(`input[name="q_${qid}"]:checked`);
    const chosen = chosenEl ? chosenEl.value : null;
    const isCorrect = chosen === meta.answer;
    if (isCorrect) correct++;
    else {
      if (meta.part === 5) wrongP5++;
      if (meta.part === 6) wrongP6++;
      if (meta.part === 7) wrongP7++;
    }
    const analysis = document.getElementById("analysis_" + qid);
    if (analysis) {
      const info = findQuestionById(qid);
      const baseText = `ä½ çš„ç­”æ¡ˆï¼š${chosen || "æœªä½œç­”"}ï¼›æ­£ç¡®ç­”æ¡ˆï¼š${meta.answer}ã€‚`;
      const expl = info && info.explanation ? `è§£æï¼š${info.explanation}` : "";
      analysis.style.display = "block";
      if (isCorrect) {
        analysis.classList.remove("analysis-wrong");
        analysis.classList.add("analysis-correct");
        analysis.textContent = "âœ” æ­£ç¡®ã€‚" + (expl ? " " + expl : "");
      } else {
        analysis.classList.remove("analysis-correct");
        analysis.classList.add("analysis-wrong");
        analysis.textContent = "âœ˜ é”™è¯¯ã€‚" + baseText + (expl ? " " + expl : "");
      }
    }
  }

  const elapsedSec = Math.floor((Date.now() - startTime) / 1000);
  const avg = total ? (elapsedSec / total).toFixed(1) : "--";
  document.getElementById("avgTime").textContent = avg;
  document.getElementById("timer").textContent =
    String(Math.floor(elapsedSec / 60)).padStart(2, "0") + ":" +
    String(elapsedSec % 60).padStart(2, "0");

  const accuracy = total ? (correct / total * 100).toFixed(1) : "0.0";
  document.getElementById("summaryText").textContent =
    `å…± ${total} é¢˜ï¼Œç­”å¯¹ ${correct} é¢˜ï¼Œæ­£ç¡®ç‡ ${accuracy}% ã€‚æ€»ç”¨æ—¶ ${elapsedSec} ç§’ï¼Œå¹³å‡æ¯é¢˜ ${avg} ç§’ã€‚`;

  const stats = document.getElementById("detailStats");
  stats.innerHTML = "";
  if (wrongP5 + wrongP6 + wrongP7 === 0) {
    stats.textContent = "æœ¬æ¬¡å…¨éƒ¨åšå¯¹ï¼Œå¯ä»¥é€‚å½“æé«˜é¢˜é‡æˆ–ç¼©çŸ­æ—¶é—´ã€‚";
  } else {
    if (wrongP5) stats.innerHTML += `<span class="pill">Part5 é”™é¢˜ï¼š${wrongP5}</span>`;
    if (wrongP6) stats.innerHTML += `<span class="pill">Part6 é”™é¢˜ï¼š${wrongP6}</span>`;
    if (wrongP7) stats.innerHTML += `<span class="pill">Part7 é”™é¢˜ï¼š${wrongP7}</span>`;
  }

  const adviceEl = document.getElementById("advice");
  let advice = "";
  if (wrongP5) advice += "ğŸ“ Part5ï¼šæŠŠé”™é¢˜æŒ‰ç…§è¯­æ³•ç‚¹ï¼ˆæ—¶æ€ã€è¯æ€§ã€è¿è¯ç­‰ï¼‰åˆ†ç±»ï¼Œé’ˆå¯¹åŒç±»å†åš 5ï½10 é¢˜ã€‚\n";
  if (wrongP6) advice += "ğŸ“š Part6ï¼šç»ƒä¹ â€œå…ˆçœ‹ç©ºæ ¼ç¼–å· â†’ å†è¯»æ®µè½â€çš„é¡ºåºï¼Œæ³¨æ„å‰åå¥é€»è¾‘è¡”æ¥ã€‚\n";
  if (wrongP7) advice += "ğŸ“– Part7ï¼šå…ˆè¯»é—®é¢˜å†è¯»æ–‡ç« ï¼Œæ ‡è®°æ—¥æœŸã€æ•°å­—ã€äººç‰©ç­‰ä¿¡æ¯ï¼Œå‡å°‘æ¥å›æ‰¾çš„æ—¶é—´ã€‚\n";
  if (!advice) advice = "æœ¬æ¬¡è¡¨ç°å¾ˆå¥½ï¼Œå¯ä»¥å°è¯•åœ¨ç›¸åŒæ—¶é—´å†…æŠŠé¢˜é‡ä» 20 æåˆ° 30ï¼Œå†è§‚å¯Ÿæ­£ç¡®ç‡å˜åŒ–ã€‚";
  adviceEl.textContent = advice;

  // å†™å…¥å†å²
  saveHistory({
    time: new Date().toLocaleString(),
    total,
    correct,
    accuracy,
    elapsedSec,
    avgTime: avg,
    wrongP5, wrongP6, wrongP7
  });

  document.getElementById("resultCard").style.display = "block";
  renderHistory();
}

/** åœ¨é¢˜åº“ä¸­é€šè¿‡ qid æ‰¾åˆ°é¢˜ç›®ï¼Œä¸»è¦ç”¨äºæ˜¾ç¤ºè§£æ */
function findQuestionById(qid) {
  if (typeof PART5_QUESTIONS !== "undefined") {
    for (const q of PART5_QUESTIONS) {
      if (q.id === qid) return q;
    }
  }
  if (typeof PART6_SETS !== "undefined") {
    for (const set of PART6_SETS) {
      for (const q of set.questions) {
        if (q.id === qid) return q;
      }
    }
  }
  if (typeof PART7_SETS !== "undefined") {
    for (const set of PART7_SETS) {
      for (const q of set.questions) {
        if (q.id === qid) return q;
      }
    }
  }
  return null;
}

// å†å²è®°å½•
const HISTORY_KEY = "toeic_trainer_v3_history";

function loadHistory() {
  try {
    const raw = localStorage.getItem(HISTORY_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch {
    return [];
  }
}

function saveHistory(entry) {
  const list = loadHistory();
  list.unshift(entry);
  localStorage.setItem(HISTORY_KEY, JSON.stringify(list.slice(0, 50)));
}

function renderHistory() {
  const box = document.getElementById("historyBox");
  const list = loadHistory();
  if (!list.length) {
    box.innerHTML = '<div style="color:#9ca3af;">æš‚æ— è®°å½•ã€‚</div>';
    return;
  }
  box.innerHTML = "";
  list.forEach(item => {
    const div = document.createElement("div");
    div.style.borderBottom = "1px dashed #e5e7eb";
    div.style.padding = "4px 0";
    div.innerHTML = `
      <div><strong>${item.time}</strong></div>
      <div>
        <span class="pill">é¢˜æ•°ï¼š${item.total}</span>
        <span class="pill">æ­£ç¡®ç‡ï¼š${item.accuracy}%</span>
        <span class="pill">å¹³å‡ç”¨æ—¶ï¼š${item.avgTime}s</span>
      </div>
      <div style="margin-top:2px;">
        ${item.wrongP5 ? `<span class="pill">P5 é”™ï¼š${item.wrongP5}</span>` : ""}
        ${item.wrongP6 ? `<span class="pill">P6 é”™ï¼š${item.wrongP6}</span>` : ""}
        ${item.wrongP7 ? `<span class="pill">P7 é”™ï¼š${item.wrongP7}</span>` : ""}
      </div>
    `;
    box.appendChild(div);
  });
}

// äº‹ä»¶ç»‘å®š
document.getElementById("startBtn").addEventListener("click", () => {
  const n = parseInt(document.getElementById("countInput").value, 10) || 20;
  buildSession(n);
  renderSession();
  startTimer();
});

document.getElementById("submitBtn").addEventListener("click", () => {
  grade();
});

document.getElementById("toggleHistory").addEventListener("click", () => {
  const box = document.getElementById("historyBox");
  box.style.display = box.style.display === "none" ? "block" : "none";
});

renderHistory();
</script>
</body>
</html>
